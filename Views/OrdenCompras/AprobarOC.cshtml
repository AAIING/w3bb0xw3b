
@{
    Layout = null;
}

<style>
    table#table_OrdenComprass tr:hover {
        cursor: pointer;
    }

    .pdfpreview {
        width: 100%;
        height: 600px;
    }
</style>
<div id="ajax_loader" style="position: absolute; left: 50%; top: 50%; z-index: 50000; display: none">
    <b>cargando ...</b>
    <img src="../../../images/loading_page.gif" width="20" height="20" />
</div>
<div class="modal fade" id="modal_item_eliminar" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog_eliminar">
        <div class="modal-content">
            <input type="hidden" id="referencia_ordend" />
            <input type="hidden" id="numero_ordend" />

            <div class="modal-header header_modal">
                <button id="close_modal_eliminar" type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h3 class="modal-title titulo_modal_h3">Eliminar Item</h3>
            </div>
            <div class="modal-body">
                ¿Está seguro de eliminar el item?<br />
                <br />
                <div class="form-horizontal">
                    <input type="hidden" name="rut_hidden" id="rut_hidden" />
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary pull-left" data-dismiss="modal">Cancelar</button>
                        <input type="submit" class="btn btn-danger" value="Eliminar" id="eliminar_item" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <h3 class="page-header-azuloscuro top_tituloencabezado">
            Aprobar Orden de Compra
        </h3>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div id="divpartialOrdenCompras"></div>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div id="divpartialDetalleOrdenCompras"></div>
    </div>
</div>
<div class="modal fade" id="modal_odencompra" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 95% !important">
        <div class="modal-content">
            <div class="modal-header header_modal">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h3 class="titulo_modal_h3 modal-title" id="myModalLabel">ORDEN DE COMPRA</h3>
            </div>
            <div class="modal-body">

                <div id="dte_preview">
                    <div style="position: absolute; left: 50%; top: 50%; z-index: 1000;">
                        <b>cargando ...</b>
                        <img src="../../../images/loading_page.gif" />
                    </div>
                </div>
                <br />
                <div class="form-horizontal">
                    <div class="modal-footer">
                        <div class="text-center">
                            <div class="row">
                                <div class="col-xs-0 col-sm-0 col-md-3">
                                </div>
                                <div class="col-xs-4 col-sm-4 col-md-2">
                                    <button type="button" id="id_rechazar" class="btn btn-danger pull-right" data-dismiss="modal">Rechazar</button>
                                </div>
                                <div class="col-xs-4 col-sm-4 col-md-2">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                                </div>
                                <div class="col-xs-4 col-sm-4 col-md-2">
                                    <button type="button" id="id_aceptar" class="btn btn-primary pull-left">Aceptar</button>
                                </div>
                                <div class="col-xs-0 col-sm-0 col-md-3">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<form id="id_form_observacionrechazo" method="POST" name="fileinfo" role="form">
    <div class="modal fade" id="modal_obsevacionrechazo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel_rechazo" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header header_modal">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h3 class="titulo_modal_h3 modal-title" id="myModalLabel_rechazo">Escriba el motivo del rachazo</h3>
                </div>
                <div class="modal-body">
                    <textarea class="form-control validate[required]]" rows="5" id="idobservacionrechazo"></textarea>
                    <div class="form-horizontal">
                        <div class="modal-footer">
                            <div class="text-center">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
                                <button type="button" id="id_confirmarrechazo" class="btn btn-danger" data-dismiss="modal">Confirmar Rechazo</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<div class="row">
    <div class="col-lg-1 col-md-0 col-xs-0"></div>
    <div class="col-lg-10 col-md-12 col-xs-12">

        <div id="idDivPartialListado_OrdenCompra">
        </div>
    </div>
    <div class="col-lg-1 col-md-0 col-xs-0"></div>
</div>

<div class="modal fade" id="modal_obsevaciondetalleOC" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="myModalLabel_obsevaciondetalleOC" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header_modal">
                <button type="button" class="close cerrar_obs_OrdenCompras" aria-label="Close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                <h3 class="titulo_modal_h3 modal-title" id="myModalLabel_obsevaciondetalleOC">Observación</h3>
            </div>
            <div class="modal-body">
                <textarea class="form-control" rows="5" id="idobsevaciondetalleOC"></textarea>
                <div class="form-horizontal">
                    <div class="modal-footer">
                        <div class="text-center">
                            <button type="button" class="btn btn-default cerrar_obs_OrdenCompras" data-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<form id="form_envio_correo">
    <div class="modal fade" id="modal_enviocorreo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header header_modal">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h3 class="titulo_modal_h3 modal-title" id="myModalLabel">ENVÍAR ORDEN DE COMPRA</h3>
                </div>
                <div class="modal-body">

                    <br />
                    <div class="form-horizontal">
                        <div class="modal-footer">
                            <div class="row">
                                <div class="col-lg-2">
                                    Email
                                </div>
                                <div class="col-lg-6">
                                    <input type="text" id="id_email_destinatario" class="form-control validate[required,custom[ValidaEmail]]">
                                </div>
                                <div class="col-lg-2">
                                    <input type="submit" class="enviar_correo_enviar btn btn-primary" value="Enviar">
                                </div>
                                <div class="col-lg-2">
                                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<script type="text/javascript" class="init">
    var numero_orden_global = 0;
    var email_proveedor_global = "";
    var fila_global = 0;
    var table_det = "";
    $(document).ready(function () {
        listar_Ordenes();
        $('#modal_obsevacionrechazo').on('shown.bs.modal', function () {
            $('#modal_obsevacionrechazo #idobservacionrechazo').focus();
        });
        $("#id_rechazar").on('click', function (ev) {
            ev.preventDefault();
            $("#modal_obsevacionrechazo").modal("show");
        });

        $('#id_form_observacionrechazo').validationEngine();
        $("#id_confirmarrechazo").on('click', function (ev) {
            ev.preventDefault();
            var ind_guarda = 1;
            if (!$("#id_form_observacionrechazo").validationEngine('validate')) {
                return false;
                ind_guarda = 0;
            }
            $.ajax({
                type: "POST",
                url: '/OrdenCompras/RechazarVBuno/',
                traditional: true,
                data: {
                    numero: numero_orden_global,
                    observacion: $("#idobservacionrechazo").val()
                },
                DataType: 'json',
                success: function (data) {

                    if (data == "1") {
                        $("#ajax_loader").hide();
                        $("#modal_odencompra").modal("hide");
                        mostrar_msj_success('Orden de Compra rechazada correctamente');
                        $("#divpartialDetalleOrdenCompras").html("");
                        listar_Ordenes();
                    } else if (data == "-1") {
                        $("#ajax_loader").hide();
                        $("#modal_odencompra").modal("hide");
                        mostrar_msj_error("error: El tiempo de sesión ha expirado");
                    } else {
                        $("#ajax_loader").hide();
                        $("#ajax_loader").modal("hide");
                        mostrar_msj_error("error interno: " + data);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    mostrar_msj_error("error: " + errorThrown);
                    //alert("errorThrown: " + errorThrown + "XMLHttpRequest: " + XMLHttpRequest + "textStatus: " + textStatus);
                }
            });
        });

        $('#form_envio_correo').validationEngine();
        $(".enviar_correo_enviar").on('click', function (ev) {
            ev.preventDefault();
            if (!$("#form_envio_correo").validationEngine('validate')) {
                return false;
            }
            var destinatario = $("#id_email_destinatario").val();
            $("#ajax_loader").css("display", "");

            var fd = new FormData();
            fd.append("numero", numero_orden_global);
            fd.append("destinatario", destinatario);
            $.ajax({
                data: fd,
                DataType: 'json',
                contentType: false,
                processData: false,
                type: "POST",
                url: '/OrdenCompras/EnviaOrdenProveedor/',
                success: function (data) {
                    if (data.retornoJson == "1") {
                        $("#ajax_loader").hide();
                        $("#modal_enviocorreo").modal("hide");
                        mostrar_msj_success('Orden de Compra enviada correctamente al proveedor');
                    } else if (data.retornoJson == "-1") {
                        $("#ajax_loader").hide();
                        $("#modal_enviocorreo").modal("hide");
                        mostrar_msj_error("error: El tiempo de sesión ha expirado");
                    } else if (data.retornoJson == "2") {
                        $("#ajax_loader").hide();
                        $("#modal_enviocorreo").modal("hide");
                        mostrar_msj_error("Email vacio del cliente");
                    } else {
                        $("#ajax_loader").hide();
                        $("#modal_enviocorreo").modal("hide");
                        mostrar_msj_error("error interno: " + data.errorMsjJson);
                    }
                }/*,*/
                //error: function (XMLHttpRequest, textStatus, errorThrown) {
                //    mostrar_msj_error("error: " + errorThrown);
                //    //alert("errorThrown: " + errorThrown + "XMLHttpRequest: " + XMLHttpRequest + "textStatus: " + textStatus);
                //}
            });


        });
        $("#eliminar_item").on('click', function (ev) {
            ev.preventDefault();
            var referencia = $("#referencia_ordend").val();
            var numero = $("#numero_ordend").val();


            var fd = new FormData();
            fd.append("numero", numero);
            fd.append("referencia", referencia);
            $.ajax({
                data: fd,
                DataType: 'json',
                contentType: false,
                processData: false,
                type: "POST",
                url: '/OrdenCompras/EliminarOrdenD',
                success: function (data) {
                    if (data.retornoJson == 1) {
                        debugger;
                        $("#ajax_loader").hide();
                        $("#modal_item_eliminar").modal("hide");
                        mostrar_msj_success('Item eliminado correctamente');
                        $("#idtotal_" + fila_global).html(Moneda(data.totalJson));
                        var subtotal = data.subtotalJson;
                        var iva = data.ivaJson;
                        var exento = data.exentoJson;
                        var afecto = data.afectoJson;
                        var total = data.totalJson;
                        $("#pdf_" + fila_global).attr("data-subtotal", subtotal);
                        $("#pdf_" + fila_global).attr("data-exento", exento);
                        $("#pdf_" + fila_global).attr("data-afecto", afecto);
                        $("#pdf_" + fila_global).attr("data-iva", iva);
                        $("#pdf_" + fila_global).attr("data-total", total);
                        listar_DetalleOrdenes(numero);
                    } else if (data.retornoJson == -1) {
                        $("#ajax_loader").hide();
                        $("#modal_odencompra").modal("hide");
                        mostrar_msj_error(data.error_msj);

                    } else {
                        $("#ajax_loader").hide();
                        $("#modal_odencompra").modal("hide");
                        mostrar_msj_error("error interno: " + data);

                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    mostrar_msj_error("error: " + errorThrown);
                    //alert("errorThrown: " + errorThrown + "XMLHttpRequest: " + XMLHttpRequest + "textStatus: " + textStatus);
                }
            });
        });
        $("#id_aceptar").on('click', function (ev) {
            ev.preventDefault();
            $.ajax({
                type: "POST",
                url: '/OrdenCompras/AceptarVBuno/',
                traditional: true,
                data: {
                    numero: numero_orden_global
                },
                DataType: 'json',
                success: function (data) {
                    if (data == "1") {
                        $("#ajax_loader").hide();
                        $("#modal_odencompra").modal("hide");
                        mostrar_msj_success_ordencompraaprobada('Orden de Compra aprobada correctamente');
                        $("#divpartialDetalleOrdenCompras").html("");
                    } else if (data == "-1") {
                        $("#ajax_loader").hide();
                        $("#modal_odencompra").modal("hide");
                        mostrar_msj_error("error: El tiempo de sesión ha expirado");

                    } else {
                        $("#ajax_loader").hide();
                        $("#modal_odencompra").modal("hide");
                        mostrar_msj_error("error interno: " + data);

                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    mostrar_msj_error("error: " + errorThrown);
                    //alert("errorThrown: " + errorThrown + "XMLHttpRequest: " + XMLHttpRequest + "textStatus: " + textStatus);
                }
            });
        });
    });
    function listar_Ordenes() {
        var url_action = '@Html.Raw(Url.Action("partialListadoVistoBueno", "OrdenCompras"))';
        $("#ajax_loader").css("display", "");
        $.ajax({
            contentType: false,
            processData: false,
            type: 'POST',
            url: url_action,
            success: function (result) {
            $("#ajax_loader").hide();
            if (result == -1) {
                mostrar_msj_error("Su Sessión a ha expirado. Ingrese al Sistema nuevamente");
                window.location.href = "/../Home/Login";
            } else {
                $("#divpartialOrdenCompras").html(result);
            }
            }
        });
    }

    function listar_DetalleOrdenes(numero) {
        var url_action = '@Html.Raw(Url.Action("partialListadoDetalleEditaOC", "OrdenCompras",new { numero="numero_"}))';
        url_action = url_action.replace("numero_", numero);
        $("#ajax_loader").css("display", "");
        $.ajax({
            contentType: false,
            processData: false,
            type: 'POST',
            url: url_action,
            success: function (result) {
            $("#ajax_loader").hide();
            if (result == -1) {
                mostrar_msj_error("Su Sessión a ha expirado. Ingrese al Sistema nuevamente");
                window.location.href = "/../Home/Login";
            } else {
                $("#divpartialDetalleOrdenCompras").html(result);
            }
            }
        });
    }


</script>