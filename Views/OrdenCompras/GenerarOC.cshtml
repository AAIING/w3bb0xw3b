
@{
    /**/

    Layout = null;
}
<div id="ajax_loader" style="position: absolute; left: 50%; top: 50%; z-index: 50000; display: none">
    <b>cargando ...</b>
    <img src="../../../images/loading_page.gif" width="20" height="20" />
</div>
<div class="row">
    <div class="col-lg-12">
        <h3 class="page-header-azuloscuro top_tituloencabezado">
            Generar Orden de Compra
        </h3>
    </div>
</div>
<div class="row">

    <div class="col-lg-1 col-xs-12 col-sm-12">
        <label>
            &nbsp;Proveedor
        </label>
    </div>
    <div class="col-lg-1 col-xs-3 col-sm-3 ancho_pixel" style="padding-right: 0 !important;">
        <input type="text" class="form-control text-right" id="rutproveedor" style="padding-left: 0 !important;" placeholder="xxx" value="" readonly>
    </div>
    <div class="col-lg-4 col-xs-9 col-sm-9" style="padding-left: 0 !important;">
        <div class="input-group input-group-md">
            <input type="text" class="form-control" id="nombreproveedor" placeholder="Nombre Proveedor" value="" readonly>
            <span class="input-group-btn">
                <button class="btn btn-primary" type="button" id="idabreModalProveedores">
                    <i class="glyphicon glyphicon-folder-open"></i>
                </button>
            </span>
        </div>
    </div>

    <div class="col-lg-2 col-xs-6 col-sm-3">
        <input type="date" class="form-control" id="fechaactual" readonly>
    </div>
    <div class="col-lg-1 col-xs-6 col-md-2 col-sm-3">
        <button class="btn btn-warning" id="btn_nueva_linea" title="Agregar linea">+ <i class="glyphicon glyphicon-file"></i></button>
    </div>
    <div class="col-lg-1 col-xs-3 col-sm-3">
        <label>
            &nbsp;N°Orden
        </label>
    </div>
    <div class="col-lg-1 col-xs-3 col-sm-3">
        <input type="text" class="form-control" id="numerooden" readonly>
    </div>

    <div class="col-lg-1 col-xs-6 col-sm-3">
        <button class="btn btn-primary" id="guardar" title="Agregar linea"><i class="glyphicon glyphicon-floppy-save"></i></button>
    </div>
</div>
<div class="table-responsive">
    <table id="listado_table_ingresaroc" class="table table-striped table-bordered tableSection table_consulta" cellspacing="0" width="100%">
        <thead>
            <tr style="background-color: #FF9A00; color: #fff">
                <th style="width:8%">Codigo</th>
                <th style="width:6%">Un&nbsp;&nbsp;</th>
                <th style="width:30%">Detalle&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                <th style="width:5%">Obs</th>
                <th style="width:10%">Cantidad a Comprar</th>
                <th style="width:15%">Precio&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                <th style="width:5%">%Desc&nbsp;&nbsp;</th>
                <th style="width:19%">Valor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>

                <th style="width:2%" class="text-center"><i class="fa fa-remove" aria-hidden="true" style="font-size: 16px"></i></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <input id="idcodigo_1" type="text" class="fila_ordenes form-control_tablegrande" data-fila="1" readonly />
                </td>
                <td>
                    <input id="idun_1" type="text" class="form-control_tablegrande" data-fila="1" onfocus="this.select()" />
                </td>
                <td>
                    <input id="iddetalle_1" type="text" class="form-control_tablegrande" data-fila="1" onfocus="this.select()" />
                </td>
                <td>
                    <button type="button" id="idbtnobs_1" class="fila_observacion" data-fila="1" style="width: 100%" data-observacion=""><i class="fa fa-comment fa-2x" aria-hidden="true" style="font-size: 16px"></i></button>
                </td>
                <td>
                    <input id="idcantidad_1" type="text" class="form-control_tablegrande text-right" autocomplete="off" data-fila="1" onblur="calcularValorFila(1)" onfocus="this.select()" onkeypress="return SoloNumerosDecimales(event, '0.0', 8, 2);" />
                </td>
                <td>
                    <input id="idprecio_1" type="text" class="form-control_tablegrande text-right" autocomplete="off" data-fila="1" onblur="calcularValorFila(1)" onfocus="this.select()" onkeypress="return SoloNumerosDecimales(event, '0.0', 8, 2);" />
                </td>
                <td>
                    <input id="iddescuento_1" type="text" class="form-control_tablegrande text-right" data-fila="1" autocomplete="off" onblur="calcularValorFila(1)" onfocus="this.select()" onkeypress="return SoloNumerosDecimales(event, '0.0', 2, 2);" />
                </td>
                <td>
                    <input id="idvalor_1" type="text" class="form-control_tablegrande text-right" data-fila="1" readonly />
                </td>
                <td>
                    <button type="button" class="oc_deleted" data-fila="1" style="width: 100%">X</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="modal fade" id="modal_lista_proveedores" tabindex="-1" role="dialog" aria-labelledby="myModalLabel_proveedores" aria-hidden="true" style="margin-top: 80px">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header_modal">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h3 class="titulo_modal_h3 modal-title" id="myModalLabel_proveedoress">proveedores <span style="font-size: 16px"></span></h3>
            </div>
            <div class="modal-body">
                <select id="listado_proveedores" class="form-control selectpicker" data-live-search="true">
                    <option value="0">--Cargando Datos--</option>
                </select>
            </div>
            <div class="modal-footer">
                <button id="btn_elegir_modal_proveedores" type="button" class="btn btn-danger pull-left">Elegir</button>
                <button type="button" class="btn btn-default pull-right" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal_codigo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel_codigo" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header_modal">
                <button type="button" class="close" aria-label="Close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                <h3 class="titulo_modal_h3 modal-title" id="myModalLabel_codigo">Productos <span style="font-size: 16px"></span></h3>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-2">Código</div>
                    <div class="col-lg-2">
                        <input type="text" class="form-control" id="codigo_prod_buscar">
                    </div>
                    <div class="col-lg-2">Nombre</div>
                    <div class="col-lg-4">
                        <input type="text" class="form-control" id="nombre_prod_buscar">
                    </div>
                    <div class="col-lg-1">
                        <button type="button" class="btn btn-primary pull-right" id="btn_buscarproductos" title="Buscar producto"><i class="fa fa-search" aria-hidden="true"></i></button>
                    </div>
                    <div class="col-lg-1">
                        <button type="button" class="btn btn-primary pull-right" id="btn_agregarinsumo" title="Agregar Insumo"><i class="fa fa-plus" aria-hidden="true"></i></button>
                    </div>
                </div>
                <div id="listado_productos"></div>
            </div>
            <div class="modal-footer">
                <div class="text-center">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>
<form id="id_form_insumos" method="POST" name="fileinfo" role="form">
    <div class="modal fade" id="modal_insumo" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header header_modal">
                    <button type="button" class="close" aria-label="Close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                    <h3 class="titulo_modal_h3 modal-title">Producto <span style="font-size: 16px"></span></h3>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <div class="row">
                            <div class="col-lg-3">
                                <label>Codigo </label>
                            </div>
                            <div class="col-lg-9">
                                <input id="codigop" type="text" class="form-control validate[required,custom[VerificaCodigoExistente_Producto]]" placeholder="xxx">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <label>Nombre </label>
                            </div>
                            <div class="col-lg-9">
                                <input id="nombreinsumo" type="text" class="form-control validate[required]" placeholder="Nombre Producto">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <label>Unidad </label>
                            </div>
                            <div class="col-lg-9">
                                <input id="unidadinsumo" type="text" class="form-control validate[required]" placeholder="Unidad prod" maxlength="5">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <label>Insumo</label>
                            </div>
                            <div class="col-lg-9">
                                <select id="listado_insumos" class="form-control validate[required]">
                                    <option value="">--Cargando--</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <label>Familia</label>
                            </div>
                            <div class="col-lg-9">
                                <select id="listado_familias" class="form-control validate[required]">
                                    <option value="">--Cargando--</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <label>Peso Grs.</label>
                            </div>
                            <div class="col-lg-9">
                                <input id="pesogrs" type="text" class="form-control text-right" onkeypress="return validateEnteroKeyPress(this,event);" maxlength="5">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <label>Precio Venta </label>
                            </div>
                            <div class="col-lg-9">
                                <input id="precioventa" type="text" class="form-control validate[required]" onkeypress="return validateEnteroKeyPress(this,event);" placeholder="Precio" maxlength="10">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <label>Presentación</label>
                            </div>
                            <div class="col-lg-9">
                                <input type="checkbox" id="indpresentacion" class="" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <label>Cabeza/ Esquelon</label>
                            </div>
                            <div class="col-lg-9">
                                <input type="checkbox" id="indcabezaesquelon" class="" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-3">
                                <label>Observación</label>
                            </div>
                            <div class="col-lg-9">
                                <textarea id="observacionesp" class="form-control" rows="3" maxlength="5000"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="text-center">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" id="guardarproducto">Guardar</button>

                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
<div class="modal fade" id="modal_obsevacion" tabindex="-1" role="dialog" aria-labelledby="myModalLabel_obsevacion" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header_modal">
                <button type="button" class="close" aria-label="Close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                <h3 class="titulo_modal_h3 modal-title" id="myModalLabel_obsevacion">Observación</h3>
            </div>
            <div class="modal-body">
                <textarea class="form-control" rows="5" id="idobservacion"></textarea>
            </div>
            <div class="form-horizontal">
                <div class="modal-footer">
                    <div class="text-center">
                        <button type="button" class="btn btn-default cerrar_obs" data-dismiss="modal">Cerrar</button>
                        <input id="btn_guardar_obs" type="submit" class="btn btn-primary" value="Guardar" />
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="modal_advertencia_eliminar" tabindex="-1" role="dialog" aria-labelledby="myModalLabel_cerrar" aria-hidden="true">
    <div class="modal-dialog modal-dialog_eliminar">
        <div class="modal-content">
            <div class="modal-header header_modal_advertencia">
                <button id="close_modal_eliminar" type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h3 class="modal-title titulo_modal_h3" id="myModalLabel_cerrar">Eliminar </h3>
            </div>
            <div class="modal-body text-center">
                <div style="font-size:16px;">¿Está seguro de eliminar la fila?</div> <br />
                <br />
                <div class="form-horizontal">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary pull-left" data-dismiss="modal">Cancelar</button>
                        <input id="btn_eliminar_oc" type="submit" class="btn btn-danger" value="Borrar" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal_modificaordenes" tabindex="-1" data-backdrop="static" data-keyboard="false" role="dialog" aria-labelledby="myModalLabel_consultaordenes" aria-hidden="true">
    <div class="modal-dialog modal_modifica" style="width: 85%;">
        <div class="modal-content">
            <div class="modal-header header_modal">
                <button id="close_modal_consultaordenes" type="button" class="close cerrar_ingreso_ordenes" aria-label="Close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>
                <h3 class="modal-title titulo_modal_h3" id="myModalLabel_consultaodenes">Ingreso Orden de Compra</h3>
            </div>
            <div class="modal-body">
                <div id="idDivPartial_encabezadoOrdenCompra"></div>
            </div>
            <div class="form-horizontal">
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-lg-4">
                            <button class="btn btn-primary center-block" type="button" id="confirmar">
                                <i class="fa fa-floppy-o" aria-hidden="true"></i>Confirmar
                            </button>
                        </div>
                        <div class="col-lg-4">
                            <button class="btn btn-danger center-block" type="button" id="eliminar_confirmacion">
                                <i class="fa fa-remove" aria-hidden="true"></i>Eliminar
                            </button>
                        </div>
                        <div class="col-lg-4">
                            <button type="button" class="btn btn-default center-block cerrar_ingreso_ordenes"><i class="glyphicon glyphicon-circle-arrow-left" style="color: red"></i>Cerrar</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="modal_obsevaciondetalleOC" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="myModalLabel_obsevaciondetalleOC" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header header_modal">
                <button type="button" class="close cerrar_obs_ocompra" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h3 class="titulo_modal_h3 modal-title" id="myModalLabel_obsevaciondetalleOC">Observación</h3>
            </div>
            <div class="modal-body">
                <textarea class="form-control" rows="5" id="idobsevaciondetalleOC"></textarea>
                <div class="form-horizontal">
                    <div class="modal-footer">
                        <div class="text-center">
                            <button type="button" class="btn btn-default cerrar_obs_ocompra" data-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" class="init">
    var fila_seleccionada = 0;
    var table_productos = "";
    var veces_modalproducto_abierto = 0;
    var fila_tr = "";
    var table_det = "";
    $("#fechaactual").val(aaaammdd(new Date()));
    var listado_table_ingresaroc = "";
    $(document).ready(function () {
        obtieneNumOrden();
        cargar_familia();
        cargar_insumos("");
        listado_table_ingresaroc = $('#listado_table_ingresaroc').DataTable({
            destroy: true,
            "bInfo": false,
            "bPaginate": false,
            "searching": false,
            "lengthChange": false,
            "lengthMenu": [[10, 15, 45, 75, 105, 135, 165, 195, 225, 255, 285], [10, 15, 45, 75, 105, 135, 165, 195, 225, 255, 285]],
            "language": {
                "sProcessing": "Procesando...",
                "sLengthMenu": "Mostrar _MENU_ registros",
                "sZeroRecords": "No se encontraron resultados",
                "sEmptyTable": "Ningún dato disponible en esta tabla",
                "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                "sInfoPostFix": "",
                "sSearch": "Buscar:",
                "sUrl": "",
                "sInfoThousands": ",",
                "sLoadingRecords": "Cargando...",
                "oAria": {
                    "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                },
                "paginate": {
                    "previous": "Anterior",
                    "next": "Siguiente"
                }
            },

            fixedHeader: {
                header: true,
                footer: true
            }
        });
        $('#id_form_insumos').validationEngine();
        $('#guardarproducto').on('click', function (e) {
            e.preventDefault();
            if (!$("#id_form_insumos").validationEngine('validate')) {
                return false;
            }
            var indpresentacion = ($("#indpresentacion").prop('checked')) ? 1 : 0;
            var indcabezaesquelon = ($("#indcabezaesquelon").prop('checked')) ? 1 : 0;
            var nombre_familia = $('#listado_familias option:selected').text();
            var nombre_insumo = $('#listado_insumos option:selected').text();
            var precioventa = $("#precioventa").val().replace(/\./g, '');
            $("#ajax_loader").css("display", "");

            $.ajax({
                type: "POST",
                url: '/OrdenCompras/GuardarProducto/',
                data: JSON.stringify({
                    codigo: $("#codigop").val(),
                    nombreproducto: $("#nombreinsumo").val(),
                    insumo: $("#listado_insumos").val(),
                    ninsumo: nombre_insumo,
                    precioventa: precioventa,
                    nfamilia: nombre_familia,
                    familia: $("#listado_familias").val(),
                    unidad: $("#unidadinsumo").val(),
                    pesogrs: $("#pesogrs").val(),
                    presentacion: indpresentacion,
                    indcabezaesquelon: indcabezaesquelon,
                    observaciones: $("#observacionesp").val()
                }),
                contentType: "application/json; charset=utf-8",
                DataType: 'json',
                success: function (data) {
                    $("#ajax_loader").css("display", "none");
                    if (data.retornoJson == 1) {
                        $("#modal_insumo").modal("hide");
                        mostrar_msj_success("Producto Guardado Correctamente");
                        $("#id_form_insumos").each(function () { this.reset(); });

                        listarProductos("", "");
                    } else if (data.retornoJson == -2) {
                        mostrar_msj_error(data.errorJson);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    mostrar_msj_error("error al guardar: " + errorThrown);
                    $("#ajax_loader").css("display", "none");
                }
            });
        });
        $('#confirmar').on('click', function (e) {
            e.preventDefault();
            $("#ajax_loader").css("display", "");

            var salir = 0;
            var subtotal = 0;
            var contador = 0;
            var plazo = ($("#plazo_conf").val() == "") ? 0 : parseFloat($("#plazo_conf").val());
            if ($("#rutproveedor").val() == "") {
                mostrar_msj_error("Debe ingresar Proveedor");
                salir = 1;
                $("#ajax_loader").css("display", "none");
                return false;
            }
            var carrito = [];
            table_det.$("input.fila_codigo_d").each(function () {
                var fila = $(this).data("fila");
                var ex = 0;
                if ($("#idex_d_" + fila).is(':checked')) {
                    ex = 1;
                } else {
                    ex = 0;
                }
                var codigo = $(this).val();
                var unidad = (table_det.$("#idunidad_d_" + fila.toString()).val());
                var detalle = table_det.$("#iddetalle_d_" + fila.toString()).val();
                var observacion = table_det.$("#idobs_d_" + fila.toString()).data("observacion");
                var cantidad = table_det.$("#idcantidad_d_" + fila.toString()).val();
                var precio = (table_det.$("#idprecio_d_" + fila.toString()).val().replace(/\./g, '').replace(/\,/g, '.'));
                var desc1 = table_det.$("#iddescuento1_d_" + fila.toString()).val();
                var valor = table_det.$("#idvalor_d_" + fila.toString()).val();


                subtotal = subtotal + ((parseFloat(precio)) * (parseFloat(cantidad)));
                //partidaArray.push(partida);
                var fila_ordenes = {
                    codigo: codigo,
                    unidad: unidad,
                    detalle: detalle,
                    observacion: observacion,
                    cantidad: parseFloat(cantidad),
                    precio: parseFloat(precio),
                    desc1: parseFloat(desc1),
                    valor: parseFloat(valor.replace(/\./g, '')),
                    ex: ex
                }
                carrito.push(fila_ordenes);
                contador++;
            });
            if (salir == 1) {
                return false;
            }
            if (contador == 0) {
                mostrar_msj_error("Debe ingresar al menos un producto");
                $("#ajax_loader").css("display", "none");
                return false;
            }
            $("#confirmar").prop("disabled", true);
            $.ajax({
                type: "POST",
                url: '/OrdenCompras/GuardarOrden/',
                data: JSON.stringify({
                    fecha: $("#fecha_conf").val(),
                    rutproveedor: $("#rutproveedor_conf").val(),
                    proveedor: $("#nombreproveedor_conf").val(),
                    condiciondep: $("#listado_condicionpago").val(),
                    condiciondee: $("#listado_condicionentrega").val(),
                    subtotal: subtotal,
                    afecto: $("#bruto_afecto_text").val().replace(/\./g, ''),
                    exento: $("#exento").val().replace(/\./g, ''),
                    iva: $("#iva_impuesto_text").val().replace(/\./g, ''),
                    total: $("#total_oc").val().replace(/\./g, ''),
                    obs: $("#iddobservacionesconf").val(),
                    plazo: plazo,
                    ordenesd: carrito,
                }),
                contentType: "application/json; charset=utf-8",
                DataType: 'json',
                success: function (data) {
                    $("#ajax_loader").css("display", "none");
                    if (data.retornoJson == 1) {
                        $("#modal_modificaordenes").modal("hide");
                        
                        mostrar_msj_success_ordencompra("Orden Guardada Correctamente")
                    } else if (data.retornoJson == -2) {
                        mostrar_msj_error(data.errorJson);
                    }

                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    mostrar_msj_error("error al guardar: " + errorThrown);
                    $("#ajax_loader").css("display", "none");
                }
            });
        });
        $("#btn_agregarinsumo").click(function (e) {
            e.preventDefault();
            $("#modal_insumo").modal("show");
        });
        $("#idabreModalProveedores").click(function (e) {
            e.preventDefault();
            listarProveedor("");
            $("#modal_lista_proveedores").modal("show");
        });
        $("#eliminar_confirmacion").click(function (e) {
            e.preventDefault();
            $("#ajax_loader").css("display", "");
            $("#modal_modificaordenes").modal("hide");
            $('#modal_modificaordenes').on('hidden.bs.modal', function () {
                var href_url = "/OrdenCompras/GenerarOC/";
                $.ajax({
                    async: false,
                    type: "POST",
                    url: href_url,
                    contentType: "application/json; charset=utf-8",
                    dataType: false,
                    success: function (result) {
                        $("#ajax_loader").css("display", "none");
                        if (result == -1) {
                            mostrar_msj_error("Su Sessión a ha expirado. Ingrese al Sistema nuevamente");
                            window.location.href = "/../Home/Login";
                        } else {
                            $("#divControlador_oc").html(result);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        mostrar_msj_error("error de Conexion");
                    }
                });
            });
        });
        $('.cerrar_ingreso_ordenes').on('click', function (e) {
            e.preventDefault();
            $("#modal_modificaordenes").modal("hide");
        });
        $("#btn_elegir_modal_proveedores").click(function (e) {
            e.preventDefault();
            $("#modal_lista_proveedores").modal("hide");
            $("#rutproveedor").val($("#listado_proveedores").val());
            $("#nombreproveedor").val($("#listado_proveedores option:selected").text());
        });
        $('#listado_table_ingresaroc tbody').on('click', '.oc_deleted', function (e) {
            e.preventDefault();
            fila_tr = $(this);
            $("#modal_advertencia_eliminar").modal("show");
        });
        $('#btn_eliminar_oc').on('click', function () {
            $("#modal_advertencia_eliminar").modal("hide");
            listado_table_ingresaroc.row(fila_tr.parents('tr')).remove().draw();

        });
        $('#btn_guardar_obs').on('click', function () {
            $("#modal_obsevacion").modal("hide");
            $("#listado_table_ingresaroc #idbtnobs_" + fila_seleccionada).data("observacion", $("#idobservacion").val());
            $("#idobservacion").val("");
        });
        $('#btn_nueva_linea').on('click', function () {
            var filav = 0;
            $("input.fila_ordenes").each(function () {
                filav = $(this).data("fila");
            });
            filav += 1;
            listado_table_ingresaroc.row.add([
                '<input type="text" id="idcodigo_' + filav + '" class="fila_ordenes form-control_tablegrande" data-fila="' + filav + '" readonly/>',
                '<input type="text" id="idun_' + filav + '" class="form-control_tablegrande" data-fila="' + filav + '"  onfocus="this.select()"/>',
                '<input type="text" id="iddetalle_' + filav + '" class="form-control_tablegrande" data-fila="' + filav + '"  onfocus="this.select()"/>',
                '<button type="button" id="idbtnobs_' + filav + '"  class="fila_observacion" data-fila="' + filav + '" style="width: 100%" data-observacion=""><i class="fa fa-comment fa-2x" aria-hidden="true" style="font-size: 16px" ></i></button>',
                '<input type="text" id="idcantidad_' + filav + '" class="form-control_tablegrande text-right" data-fila="' + filav + '" autocomplete="off" onfocus="this.select()" onblur="calcularValorFila(' + filav + ')"  onkeypress="return SoloNumerosDecimales(event, \'0.0\', 8, 2);"/>',
                '<input type="text" id="idprecio_' + filav + '" class="form-control_tablegrande text-right" data-fila="' + filav + '" autocomplete="off" onblur="calcularValorFila(' + filav + ')" onfocus="this.select()"  onkeypress="return SoloNumerosDecimales(event, \'0.0\', 8, 2);"/>',
                '<input type="text" id="iddescuento_' + filav + '" class="form-control_tablegrande text-right" data-fila="' + filav + '" autocomplete="off" onfocus="this.select()" onblur="calcularValorFila(' + filav + ')"  onkeypress="return SoloNumerosDecimales(event, \'0.0\', 2, 2);"/>',
                '<input type="text" id="idvalor_' + filav + '" class="form-control_tablegrande text-right" data-fila="' + filav + '" readonly/>',
                '<button type="button" class="oc_deleted" data-fila="' + filav + '" style="width: 100%">X</button>'
            ]).draw(false);
            veces_modalproducto_abierto = 0;
        });
        $('#listado_table_ingresaroc tbody').on('click', 'tr .fila_observacion', function (e) {
            //e.preventDefault();
            var fila = $(this).data('fila');
            var obs = $(this).data('observacion');
            fila_seleccionada = fila;
            $("#idobservacion").val(obs);
            $("#modal_obsevacion").modal("show");
        });
        $('#listado_table_ingresaroc tbody').on('click', 'tr input.fila_ordenes', function (e) {
            //e.preventDefault();
            var fila = $(this).data('fila');
            fila_seleccionada = fila;
            $("#modal_codigo").modal("show");
        });
        $('#btn_buscarproductos').on('click', function (e) {
            //e.preventDefault();
            var codigo = $("#codigo_prod_buscar").val();
            var producto = $("#nombre_prod_buscar").val();
            listarProductos(producto, codigo);
        });
        $('#modal_modificaordenes').on('shown.bs.modal', function () {
            var table = $('#table_ultimas_ventas').DataTable();
            table_det.columns.adjust();
        });
        $('#guardar').on('click', function (e) {
            e.preventDefault();
            $("#ajax_loader").css("display", "");

            var salir = 0;
            var subtotal = 0;
            var contador = 0;
            if ($("#rutproveedor").val() == "") {
                mostrar_msj_error("Debe ingresar Proveedor");
                salir = 1;
                $("#ajax_loader").css("display", "none");
                return false;
            }
            var carrito = [];
            listado_table_ingresaroc.$("input.fila_ordenes").each(function () {
                var fila = $(this).data("fila");
                //
                var codigo = $(this).val();
                if (codigo != "") {
                    var unidad = (listado_table_ingresaroc.$("#idun_" + fila.toString()).val());
                    var detalle = listado_table_ingresaroc.$("#iddetalle_" + fila.toString()).val();
                    var observacion = listado_table_ingresaroc.$("#idbtnobs_" + fila.toString()).data("observacion");
                    var cantidad = parseFloat(listado_table_ingresaroc.$("#idcantidad_" + fila.toString()).val());
                    var precio = parseFloat(listado_table_ingresaroc.$("#idprecio_" + fila.toString()).val());
                    var desc1 = parseFloat(listado_table_ingresaroc.$("#iddescuento_" + fila.toString()).val());
                    var valor = listado_table_ingresaroc.$("#idvalor_" + fila.toString()).val();

                    if (cantidad == "" || cantidad == "0") {
                        mostrar_msj_error("Debe ingresar cantidad mayor a 0 en la fila: " + fila);
                        salir = 1;
                        $("#ajax_loader").css("display", "none");
                        return false;
                    } else if (precio == "" || precio == "0") {
                        mostrar_msj_error("Debe ingresar precio mayor a 0 en la fila: " + fila);
                        salir = 1;
                        $("#ajax_loader").css("display", "none");
                        return false;
                    }
                    subtotal = subtotal + ((parseFloat(precio)) * (parseFloat(cantidad)));
                    //partidaArray.push(partida);
                    var fila_ordenes = {
                        codigo: codigo,
                        unidad: unidad,
                        detalle: detalle,
                        observacion: observacion,
                        cantidad: parseFloat(cantidad),
                        precio: parseFloat(precio),
                        desc1: parseFloat(desc1),
                        valor: parseFloat(valor.replace(/\./g, '')),
                        ex: 0

                    }
                    carrito.push(fila_ordenes);
                    contador++;
                }
            });
            if (salir == 1) {
                return false;
            }
            if (contador == 0) {
                mostrar_msj_error("Debe ingresar al menos un producto");
                $("#ajax_loader").css("display", "none");
                return false;
            }
            $.ajax({
                type: "POST",
                url: '/OrdenCompras/PrevioConfirmaOrdenesCompra/',
                data: JSON.stringify({
                    fecha: $("#fechaactual").val(),
                    rutproveedor: $("#rutproveedor").val(),
                    proveedor: $("#nombreproveedor").val(),
                    nroorden: $("#numerooden").val(),
                    subtotal: subtotal,
                    ordenesd: carrito,
                }),
                contentType: "application/json; charset=utf-8",
                //DataType: 'json',
                success: function (data) {
                    $("#ajax_loader").css("display", "none");
                    $("#modal_modificaordenes").modal("show");
                    $("#idDivPartial_encabezadoOrdenCompra").html(data);

                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    mostrar_msj_error("error al guardar: " + errorThrown);
                    $("#ajax_loader").css("display", "none");
                }
            });
        });
    });//fin del document ready

    function calcularValorFila(fila_item) {
        var cantidad = ($("#idcantidad_" + fila_item).val() == "") ? 0 : parseFloat($("#idcantidad_" + fila_item).val());
        var precio = ($("#idprecio_" + fila_item).val() == "") ? 0 : parseFloat($("#idprecio_" + fila_item).val());
        var descuento = ($("#iddescuento_" + fila_item).val() == "") ? 0 : parseFloat($("#iddescuento_" + fila_item).val());

        var valor = Math.round(cantidad * precio, 0);
        var desc = valor * descuento / 100;
        valor = parseInt(valor - desc);
        $("#idvalor_" + fila_item).val(Moneda(valor));
    }
    function cargar_insumos(nombre_insumo) {
        $('#listado_insumos').html("<option value='0' data-codigo='0'>Cargando ...</option>");
        $.getJSON('/Productos/GetInsumo/?nombre_insumo=' + nombre_insumo, function (data) {
            var items = "<option value='0' data-codigo='0'>--Seleccione--</option>";
            $("#listado_insumos").empty();
            var count = 0;
            $.each(data, function (i, district) {
                count = 1;
                items += "<option value='" + district.codigo + "' data-codigo='" + district.codigo + "'>" + district.nombre + "</option>";
            });
            if (count == 0) {
                $('#listado_insumos').html("<option value='0' data-codigo='0'>No hay datos</option>");
            } else {
                $('#listado_insumos').html(items);
            }
        });
    }

    function eventoSeleccionarProducto() {
        $('#table_productos tbody').on('click', 'tr', function (e) {
            $("#ajax_loader").css("display", "");
            var codigo = $(this).data('codigo');
            var nombre = $(this).data('nombre');
            var unidad = $(this).data('unidad');
            var retorno = 0;

            $("input.fila_ordenes").each(function () {
                var fila_orden = $(this).data("fila");
                var codigo_orden = $("#listado_table_ingresaroc #idcodigo_" + fila_orden).val();
                if (codigo_orden != "") {
                    if ((codigo == codigo_orden)) {
                        mostrar_msj_error("codigo repetido");
                        retorno = 1;
                        $("#ajax_loader").css("display", "none");
                        return false;
                    }
                }
            });

            if (retorno == 1) {
                return false;
            }
            if (veces_modalproducto_abierto == 0) {
                $("#listado_table_ingresaroc #idcodigo_" + fila_seleccionada).val(codigo);
                $("#listado_table_ingresaroc #idun_" + fila_seleccionada).val(unidad);
                $("#listado_table_ingresaroc #iddetalle_" + fila_seleccionada).val(nombre);
                $("#listado_table_ingresaroc #idcantidad_" + fila_seleccionada).val(1);
                $("#listado_table_ingresaroc #idprecio_" + fila_seleccionada).val(0);
                $("#listado_table_ingresaroc #iddescuento_" + fila_seleccionada).val(0);
                $("#listado_table_ingresaroc #idvalor_" + fila_seleccionada).val(0);

            } else {
                var fila = 0;
                $("input.fila_ordenes").each(function () {
                    fila = $(this).data("fila");
                });
                fila += 1;
                listado_table_ingresaroc.row.add([
                    '<input type="text" id="idcodigo_' + fila + '" class="fila_ordenes form-control_tablegrande" data-fila="' + fila + '" value="' + codigo + '" readonly/>',
                    '<input type="text" id="idun_' + fila + '" class="form-control_tablegrande" data-fila="' + fila + '"  onfocus="this.select()" value="' + unidad + '" />',
                    '<input type="text" id="iddetalle_' + fila + '" class="form-control_tablegrande" data-fila="' + fila + '" value="' + nombre + '" onfocus="this.select()"/>',
                    '<button type="button" id="idbtnobs_' + fila + '"  class="fila_observacion" data-fila="' + fila + '" style="width: 100%" data-observacion=""><i class="fa fa-comment fa-2x" aria-hidden="true" style="font-size: 16px"></i></button>',
                    '<input type="text" id="idcantidad_' + fila + '" class="form-control_tablegrande text-right" data-fila="' + fila + '" autocomplete="off" onfocus="this.select()" onblur="calcularValorFila(' + fila + ')"  value="1" onkeypress="return SoloNumerosDecimales(event, \'0.0\', 8, 2);"/>',
                    '<input type="text" id="idprecio_' + fila + '" class="form-control_tablegrande text-right" data-fila="' + fila + '"  onfocus="this.select()" onblur="calcularValorFila(' + fila + ')"  value="0" onkeypress="return SoloNumerosDecimales(event, \'0.0\', 8, 2);"/>',
                    '<input type="text" id="iddescuento_' + fila + '" class="form-control_tablegrande text-right" data-fila="' + fila + '" autocomplete="off" onfocus="this.select()" onblur="calcularValorFila(' + fila + ')" value="0" onkeypress="return SoloNumerosDecimales(event, \'0.0\', 2, 2);"/>',
                    '<input type="text" id="idvalor_' + fila + '" class="form-control_tablegrande text-right" data-fila="' + fila + '" value="0" readonly/>',
                    '<button type="button" class="oc_deleted" data-fila="' + fila + '" style="width: 100%">X</button>'
                ]).draw(false);

            }

            veces_modalproducto_abierto = 1;
            $("#ajax_loader").css("display", "none");

        });
    }

    function listarProveedor(nombre_proveedor) {

        $.getJSON('/Proveedores/GetProveedores/?nombre_proveedor=' + nombre_proveedor, function (data) {
            var items;
            $("#listado_proveedores").empty();
            var count = 0;
            $.each(data, function (i, district) {
                count = 1;
                items += "<option value='" + district.rut + "'>" + district.nombre + "</option>";
            });
            if (count == 0) {
                $('#listado_proveedores').html("<option value='0' >No hay datos</option>");
            } else {
                $('#listado_proveedores').html(items);
            }
            $("#listado_proveedores").selectpicker('refresh');

        });
    }

    function cargar_familia() {
        $('#listado_familias').html("<option value='0' data-codigo='0'>Cargando ...</option>");
        $.getJSON('/Familias/GetFamilia/', function (data) {
            var items = "<option value='0' data-codigo='0'>--Seleccione--</option>";
            $("#listado_insumos").empty();
            var count = 0;
            $.each(data, function (i, district) {
                count = 1;
                items += "<option value='" + district.codigo + "' data-codigo='" + district.codigo + "'>" + district.nombre + "</option>";
            });
            if (count == 0) {
                $('#listado_familias').html("<option value='0' data-codigo='0'>No hay datos</option>");
            } else {
                $('#listado_familias').html(items);
            }
        });
    }

    function listarProductos(nombre_producto, codigo) {
        $("#ajax_loader").css("display", "");
        $.getJSON('/OrdenCompras/GetInsumosOC/?nombre_insumo=' + nombre_producto + "&codigo=" + codigo, function (data) {
            var items = "";
            $("#listado_productos").html("");
            items += '<table id="table_productos" class="table table-striped table-bordered tableSection table_consulta" cellspacing="0" width="100%">';
            items += '<thead>';
            items += '<tr style="background-color: #FF9A00; color: #fff">';
            items += '      <th class="text-right">Codigo</th>';
            items += '      <th>Nombre</th>';
            items += '      <th>Unidad</th>';
            items += '    </tr>';
            items += '</thead>';
            items += '<tbody>';

            $.each(data, function (i, district) {
                items += '     <tr style="cursor: pointer" data-codigo="' + district.codigo + '" data-nombre="' + district.nombre + '" data-unidad="' + district.unidad + '" data-precio="' + district.precio + '" >';
                items += '          <td class="text-right">' + district.codigo + '</td>';
                items += '          <td>' + district.nombre + '</td>';
                items += '          <td>' + district.unidad + '</td>';
                items += '     </tr>';
            });
            items += '</tbody>';
            items += '</table>';

            $('#listado_productos').html(items);
            tablaProductos();
            eventoSeleccionarProducto();
        });
        $("#ajax_loader").css("display", "none");
    }
    function tablaProductos() {
        table_productos = $('#table_productos').DataTable({
            destroy: true,
            "bInfo": true,
            "bPaginate": true,
            "searching": false,
            "ordering": false,
            "bFilter": false,
            "bLengthChange": false,
            "lengthusuario": [[10, 15, 45, 75, 105, 135, 165, 195, 225, 255, 285], [10, 15, 45, 75, 105, 135, 165, 195, 225, 255, 285]],
            "language": {
                "sProcessing": "Procesando...",
                "sLengthMenu": "Mostrar _MENU_ registros",
                "sZeroRecords": "No se encontraron resultados",
                "sEmptyTable": "Ningún dato disponible en esta tabla",
                "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
                "sInfoPostFix": "",
                "sSearch": "Buscar:",
                "sUrl": "",
                "sInfoThousands": ",",
                "sLoadingRecords": "Cargando...",
                "oAria": {
                    "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                    "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                },
                "paginate": {
                    "previous": "Anterior",
                    "next": "Siguiente"
                }
            },
            fixedHeader: {
                header: true,
                footer: true
            }
        });
    }
    function obtieneNumOrden() {
        $.ajax({
            async: false,
            type: "POST",
            url: '/OrdenCompras/GetNumeroOrden/',
            traditional: true,
            DataType: 'json',
            success: function (data) {
                if (data.retornoJson == 1) {
                    $("#numerooden").val(data.numeroSol);
                } else {
                    mostrar_msj_error("error interno: " + data);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                mostrar_msj_error("error en obtener numero solicitud: " + errorThrown);
            }
        });
    }
</script>
